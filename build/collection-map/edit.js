(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,n=window.wp.apiFetch;var r=e.n(n);const o=window.wp.blocks,a=window.wp.element,l=window.wp.blockEditor,c=(window.wp.components,window.wp.data),s=["posts"];(0,o.registerBlockType)("muotamap/collection-map",{title:"Collection Map",icon:"location-alt",category:"muotamaps",title:"Collection Map",icon:"location-alt",description:"Dieser Block zeigt eine Karte mit allen Markern aus den Single-Maps an. Die verlinkten Magazinbeiträge, Texte und Bilder werden übernommen.",attributes:{latitude:{type:"number",default:47.0064174},longitude:{type:"number",default:8.6322735},zoom:{type:"number",default:13},markers:{type:"array",default:[]}},example:{attributes:{latitude:47.0064174,longitude:8.6322735,zoom:15,markers:[{latitude:47.009715,longitude:8.617963},{latitude:47.011441,longitude:8.643498},{latitude:47.005676,longitude:8.614187},{latitude:46.998711,longitude:8.648176}]}},edit:({attributes:e,setAttributes:n,clientId:o})=>{const{latitude:i,longitude:u,zoom:d,markers:p=[]}=e,g=(0,a.useRef)(null),m=(0,a.useRef)(null),[f,v]=(0,a.useState)(!1),[w,h]=(0,a.useState)(null),b=(0,a.useRef)(null),k=(0,a.useRef)(null),y=(0,a.useRef)(null),[E,x]=(0,a.useState)([{label:"None",value:""}]),M=(0,a.useRef)([]),[_,C]=(0,a.useState)(!1),[S,z]=(0,a.useState)(null),[B,$]=(0,a.useState)(null),[A,T]=(0,a.useState)(!1),{selectBlock:R}=(0,c.useDispatch)("core/block-editor"),D=(0,a.useRef)(!1),Z=(0,c.useSelect)((e=>e("core/block-editor").isBlockSelected(o)),[o]),I=(0,l.useBlockProps)({className:Z?"wp-block-muotamap is-selected":"wp-block-muotamap"});function N(e){e.querySelectorAll(".custom-marker").forEach((e=>{e.classList.remove("active")}))}const[P,O]=(0,a.useState)(null);(0,a.useEffect)((()=>{if("undefined"!=typeof L){const e=L.divIcon({html:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38 48" class="custom-marker"> <path class="custom-marker-svg" d="M19 48s16.3-17.7 16.3-27.2c0-9-7.4-16.3-16.5-16.2-8.9 0-16.2 7.3-16.2 16.2C2.6 30.3 18.9 48 18.9 48Zm0-32.7c3 0 5.4 2.4 5.4 5.4S22 26.1 19 26.1c-3 0-5.4-2.4-5.4-5.4 0-3 2.4-5.4 5.4-5.4Z"/></svg>',className:"custom-icon-wrapper",iconSize:[38,48],iconAnchor:[19,48],popupAnchor:[0,-48]});O(e)}}),[]),(0,a.useEffect)((()=>{(async()=>{try{const e=[];for(const t of s){const n=(await r()({path:`/wp/v2/${t}?per_page=100`})).map((e=>({label:`${e.title.rendered}`,value:`${t}-${e.id}`})));e.push(...n)}x([{label:"None",value:""},...e])}catch(e){}})()}),[]),(0,a.useEffect)((()=>{!m.current&&g.current&&(m.current=L.map(g.current,{center:[i,u],zoom:d,dragging:!1,inertia:!0}),L.tileLayer("https://api.mapbox.com/styles/v1/ulrichdigital/cm42iduyt00x101r20fa19tlr/tiles/512/{z}/{x}/{y}?access_token=pk.eyJ1IjoidWxyaWNoZGlnaXRhbCIsImEiOiJjbTQyaTk1ZjMwMHc1MmpxdzNwb2gzcnJ5In0.dNCkyJW5SkOCLz0_hGLMxA",{attribution:'&copy; <a href="https://www.mapbox.com/">Mapbox</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',tileSize:512,zoomOffset:-1,detectRetina:!0,maxZoom:19}).addTo(m.current),async function(){try{const e=await fetch("/wp-json/custom/v1/all-pages-markers");if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const t=await e.json();n({markers:t})}catch(e){console.error("Fehler beim Abrufen der Marker:",e)}}())}),[i,u,d,g]),(0,a.useEffect)((()=>{const e=m.current;if(!e||!P)return;if(!p||0===p.length)return;M.current.forEach((t=>e.removeLayer(t))),M.current=[];const t=L.latLngBounds();p.forEach((({latitude:n,longitude:r,title:o},a)=>{const l=L.marker([n,r],{icon:P}).addTo(e);M.current[a]=l,t.extend([n,r]),o&&l.bindPopup(o)})),p.length>0&&e.fitBounds(t,{padding:[50,50]})}),[p,P]),(0,a.useEffect)((()=>{if(!A||!m.current)return;const e=e=>(async(e,t,n)=>{let o=null,a=null;t&&t.popup?(o=t.popup,a=o._container):(e&&"function"==typeof e.getCenter&&e.openPopup("<p>dummy</p>",n),o=e._popup,o&&(a=o._container));const l=e.getContainer(),c=p.findIndex((e=>e.latitude===o._latlng.lat&&e.longitude===o._latlng.lng));if(-1!==c){const{latitude:e,longitude:t,title:n,text:a,image:l,linkedContent:d}=p[c];let g="content_above_image";d&&(g+=" has-linked-content"),l&&(g+=" has-image");var s="",i="",u="";const m=window.location.origin,f=async(e,t)=>{try{const n=await r()({path:`/wp/v2/${e}/${t}`}),{date:o,link:a}=n;return{date:v(o),link:a}}catch(e){return console.error("Fehler beim Abrufen des Posts:",e),null}},v=e=>{const t=new Date(e);return new Intl.DateTimeFormat("de-DE",{day:"numeric",month:"long",year:"numeric"}).format(t)};if(d){const[e,t]=d.split("-");try{const{link:n,date:r}=await f(e,t);s=n,i=r,u=`${m}/wp-admin/post.php?post=${t}&action=edit`}catch(e){console.error("Fehler beim Abrufen des Permalinks:",e)}}let w='<div class="popup_buttons">';w+=`<div class="button route" data-lat="${e}" data-lng="${t}"><svg class="ampelmann_bewegt_svg" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 50 50">\n  <path id="beinhinten" d="M12.4,43.8c-.2-.5-.5-1.2-.7-1.7-.1-.2,0-.5.2-.7.7-.6,4.2-3.4,4.2-3.4,0,0,5.9-5.1,7.4-6.3s1.2-.9,1.6-1.4c1.8-1.9,1.8-5,0-6.9s-4.4-1.9-6.3-.5c-.2.1-.4.3-.6.5h0s-.1.2-.2.3c-.3.4-.6.8-.8,1.2-1.1,1.7-2.5,3.4-6.8,8-4.7,4.9-5.6,5.9-5.8,6.4-.2.4-.2.8,0,1.1.6,1.3,6.3,6.6,7.9,7.4.7.4,1,0,.9-.8,0,0-.4-1.8-1-3.2Z"/>\n  <path id="beinvorne" d="M42.3,39c-.5.2-1.2.5-1.7.7-.2,0-.5,0-.7-.2-.6-.7-3.4-4.2-3.4-4.2,0,0-5.1-5.9-6.3-7.4s-.9-1.2-1.4-1.6c-1.9-1.8-5-1.8-6.9,0s-1.9,4.4-.5,6.3c.1.2.3.4.5.6h0s.2,0,.3.2c.4.3.8.6,1.2.8,1.7,1.1,3.4,2.5,8,6.8,4.9,4.7,5.9,5.6,6.4,5.8.4.2.8.2,1.1,0,1.3-.6,6.6-6.3,7.4-7.9.4-.7,0-1-.8-.9,0,0-1.8.4-3.2,1Z"/>\n  <path id="oberkorper" d="M30.3,4.4c2.3-1.6,3.7-2.8,3.5-3-.4-.6-1.9-.8-4.8.6-2-1.8-5.2-1.9-7.8-.2,0,0,0,0,0,0-.1-.2-.4-.2-.7,0-.3.2-.4.5-.3.7,0,0,0,0,0,0-2.4,2.1-3.3,5.2-2.3,7.6-.6.8-.7,1.2-.4,1.6.2.4.6.4,1.4,0,.2.2.5.4.7.5-.4.2-.7.2-1.2.2.3.4,1.1.6,1.8.6-.3.2-.9.5-1.2.3.6.4,1.2.3,1.9,0,0,.4-.4.6-.7.8.6,0,1.2-.2,1.7-.5,0,0,0,0,0,0,0,.2-.6,1-1.4,2.4-.3-.2-.6-.3-.9-.3-2.4-.4-5.1,3.3-5.5,5.8-.5,2.6.6,5.1,2.5,6.4.7,4.6,6,5.7,9.7,4.3,4.2-1.5,6-5.9,5-10.9-.4-1.9-1.9-3.8-2.9-5.4.2-.8,1-1,1.3-1.1,1.3-.5,3-1.5,2.9-3,0-1.5-.4-2.8-.4-2.8,0,0,1.5-1.1,1.4-1.4-.1-.4-2.6-1.3-3.3-3.2Z"/>\n</svg></div>`,w+="</div>",w+='<div class="card">',w+=`<div class="${g}">`,d&&(w+="<div class=first_row>",w+=`<p class="post-date">${i}</p>`,w+=`<div class="edit_post"><a href="${u}" target="_blank" class="post-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false"><path d="M19.5 4.5h-7V6h4.44l-5.97 5.97 1.06 1.06L18 7.06v4.44h1.5v-7Zm-13 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-3H17v3a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h3V5.5h-3Z"></path></svg></a></div>`,w+="</div>"),w+=`<h3>${n||"Kein Titel"}</h3>`,w+=`<p>${a||"Kein Text verfügbar"}</p>`,w+="</div>",l&&(w+='<div class="image_container">',w+=`<figure><img src="${l}" alt="${n||"Marker-Bild"}" style="max-width: 100%; height: auto;" /></figure>`,w+='<svg class="post_overlay" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 409.584 111.466" preserveAspectRatio="none"><path d="M0,0V111.466C169.415,95.866,219.838-22.334,409.584,18.487V0Z"></path></svg>',w+="</div>"),d&&(w+=`<div class="wave_button">\n\t\t\t\t\t\t<a class="post_link" href="${s}" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M328 416l24 0 0-24 0-240 0-24-48 0 0 24 0 182.1L81 111l-17-17L30.1 128l17 17 223 223L88 368l-24 0 0 48 24 0 240 0z"/></svg>Mehr</a>\n\t\t\t\t\t\t<svg class="overlay_bottom" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 293.702 77.466" preserveAspectRatio="none"><path class="button_wave" d="M0,77.4c38.3-2.6,73.7-6.1,129.2-35C169.1,21.7,198.4,0,249.4,0c14.9,0,29.7,1.5,44.3,4.8v72.7H0Z"></path></svg>\n\t\t\t\t\t</div>`),w+="</div>",o.setContent(w)}if(l&&a){l.querySelectorAll(".cloned-leaflet-popup").forEach((e=>e.remove()));const e=a.cloneNode(!0);e.removeAttribute("style"),e.classList.remove("leaflet-popup"),e.classList.remove("leaflet-zoom-animated"),e.classList.add("cloned-leaflet-popup"),l.appendChild(e),l.querySelectorAll(".cloned-leaflet-popup").forEach((e=>{e.querySelectorAll("[style]").forEach((e=>{e.removeAttribute("style")}))}))}})(m.current,e);return m.current.on("popupopen",e),()=>{m.current.off("popupopen",e)}}),[A,p]),(0,a.useEffect)((()=>{if(f&&null!==w&&p[w]){const{latitude:e,longitude:t}=p[w];b.current?(b.current.setView([e,t]),y.current.setLatLng([e,t])):(b.current=L.map(k.current).setView([e,t],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors",maxZoom:19}).addTo(b.current),y.current=L.marker([e,t],{icon:CustomIcon,draggable:!0}).addTo(b.current).on("dragend",(e=>{const{lat:t,lng:r}=e.target.getLatLng(),o=[...p];if(o[w]={...o[w],latitude:t,longitude:r},n({markers:o}),m.current){const e=M.current[w];if(e){e.setLatLng([t,r]);const n=e.getElement();if(n){N(m.current.getContainer());const e=n.querySelector(".custom-marker");e&&e.classList.add("active")}const a=L.latLngBounds();o.forEach((({latitude:e,longitude:t})=>{a.extend([e,t])})),m.current.setView([t,r]),m.current.fitBounds(a,{padding:[50,50]})}}})))}return()=>{!f&&b.current&&(b.current.remove(),b.current=null,y.current=null)}}),[f,w,p]);const j=(0,a.useRef)(null);(0,a.useEffect)((()=>{m.current&&f&&j.current&&(m.current.removeControl(j.current),j.current=null)}),[f,p]);const q=(0,a.useRef)(null);return(0,a.useEffect)((()=>{if(m.current){q.current&&(m.current.removeControl(q.current),q.current=null);const e=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const t=L.DomUtil.create("div","leaflet-bar custom-control leaflet-control-map_reset_container leaflet-control"),n=L.DomUtil.create("a","custom-control-button leaflet_control-map_reset",t);return n.title="Karte zentrieren",n.style.outlineStyle="none",n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" aria-hidden="true" role="img"><path d="M55.7 199.7L96 240l48 0 48 48 0 64 32 32 0 64 64 0 0-48 64-64 0-80-128 0-32-32 0-32 80 0 0-32-32-32 0-16 32-32 0-31.4c-5.3-.4-10.6-.6-16-.6C160.6 48 80.3 112.2 55.7 199.7zM464 256c0-36.9-9.6-71.5-26.4-101.6L400 192l0 80 63.4 0c.4-5.3 .6-10.6 .6-16zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"/></svg>',L.DomEvent.on(n,"click",(t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t);const n=m.current.getContainer();if(N(n),function(e){e.querySelectorAll(".cloned-leaflet-popup").forEach((e=>{e.remove()}))}(n),p.length>0){const t=L.latLngBounds(p.map((({latitude:e,longitude:t})=>[e,t])));e.fitBounds(t,{padding:[50,50]})}})),t}}),t=new e;m.current.addControl(t),q.current=t}return()=>{q.current&&(m.current.removeControl(q.current),q.current=null)}}),[p]),(0,a.useEffect)((()=>{m.current&&M.current&&M.current.forEach((e=>{e&&function(e){e._hasClickEvent||(e.on("click",(e=>{const t=e.originalEvent?.target;N(m.current.getContainer());const n=t.closest(".custom-marker");n&&n.classList.add("active")})),e._hasClickEvent=!0)}(e)}))}),[p]),(0,a.useEffect)((()=>{const e=e=>{const t=e.originalEvent?.target,n=t?.closest(".cloned-leaflet-popup .button.edit");if(n){const e=n.closest(".cloned-leaflet-popup");if(e){const t=p.findIndex((t=>e.innerHTML.includes(t.title||`Marker ${index+1}`)));-1!==t&&(v(!0),h(t))}}const r=t?.closest(".cloned-leaflet-popup .button.delete");if(r){const e=r.closest(".cloned-leaflet-popup");if(e){const t=p.findIndex((t=>e.innerHTML.includes(t.title||`Marker ${index+1}`)));-1!==t&&(C(!0),z(t))}}};return m.current.on("click",e),()=>{m.current.off("click",e)}}),[p]),(0,a.useEffect)((()=>{if(!m.current)return;const e=e=>{e.target.closest(".wp-block-muotamap-collection-map")&&R(o)},t=m.current.getContainer();return t.addEventListener("click",e),()=>{t.removeEventListener("click",e)}}),[o]),(0,a.useEffect)((()=>{if(!m.current)return;const e=e=>{const t=e.originalEvent?.target;if(!t.closest(".leaflet-marker-icon")&&!t.closest(".button")){const e=t.closest(".wp-block-muotamap-collection-map");if(e){const t=e.querySelectorAll(".cloned-leaflet-popup");t.length>0&&t.forEach((e=>{e.remove()}))}}N(m.current.getContainer())};return m.current.on("click",e),()=>{m.current.off("click",e)}}),[]),(0,a.useEffect)((()=>{if(!A||!m.current)return;const e=m.current,t=e.getContainer(),n=()=>{const n=e.dragging?._draggable;n&&n._moving&&"function"==typeof n.finishDrag&&n.finishDrag(),e.dragging.disable(),D.current=!1,t.classList.remove("dragging-on"),function(e){const t=e.dragging._draggable;t&&(t.disable(),t.enable())}(e)};n();const r=r=>{var o;(o=r.target)&&!(o.closest(".leaflet-marker-icon")||o.closest(".leaflet-popup")||o.closest(".cloned-leaflet-popup")||o.closest(".button")||o.closest(".leaflet-control")||o.closest(".leaflet-interactive"))&&(D.current?n():(e.dragging.enable(),D.current=!0,t.classList.add("dragging-on")))};return t.addEventListener("pointerdown",r,{capture:!0}),()=>{t.removeEventListener("pointerdown",r,{capture:!0}),n()}}),[A]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)("div",{...I,ref:g}),f&&null!==w&&{},_&&{})},save:({attributes:e})=>{const{latitude:n,longitude:r,zoom:o,markers:a=[]}=e,c=l.useBlockProps.save({className:"wp-block-muotamap wp-block-muotamap-collection-map alignwide","data-latitude":n,"data-longitude":r,"data-zoom":o,"data-markers":JSON.stringify(a)});return(0,t.createElement)("div",{...c})}})})();